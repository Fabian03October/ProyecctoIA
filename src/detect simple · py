"""
Script de Detecci√≥n Simple - Una C√°mara
Para pruebas y demostraci√≥n b√°sica
"""

import cv2
from ultralytics import YOLO
import pyttsx3
import threading

class DetectorSimple:
    """
    Detector simple con una c√°mara
    (Sin c√°lculo de distancia, solo detecci√≥n)
    """
    
    def __init__(self, model_path):
        print("üöÄ Cargando modelo YOLO...")
        self.model = YOLO(model_path)
        
        # Sistema de voz
        self.engine = pyttsx3.init()
        self.engine.setProperty('rate', 150)
        
        print("‚úÖ Modelo cargado")
    
    def notificar_voz(self, mensaje):
        """Notifica mediante voz"""
        def speak():
            self.engine.say(mensaje)
            self.engine.runAndWait()
        
        thread = threading.Thread(target=speak)
        thread.daemon = True
        thread.start()
    
    def ejecutar(self, camera_id=0):
        """
        Ejecuta detecci√≥n en tiempo real
        """
        print(f"\nüé• Abriendo c√°mara {camera_id}...")
        cap = cv2.VideoCapture(camera_id)
        
        if not cap.isOpened():
            print("‚ùå Error: No se pudo abrir la c√°mara")
            return
        
        print("‚úÖ C√°mara activa")
        print("\nüìå Presiona 'q' para salir\n")
        
        frame_count = 0
        
        while True:
            ret, frame = cap.read()
            if not ret:
                break
            
            # Detecci√≥n cada 3 frames (para mejor performance)
            if frame_count % 3 == 0:
                results = self.model(frame, verbose=False)
                
                # Dibujar resultados
                annotated_frame = results[0].plot()
                
                # Contar detecciones por clase
                if len(results[0].boxes) > 0:
                    clases_detectadas = {}
                    for box in results[0].boxes:
                        class_id = int(box.cls[0])
                        class_name = self.model.names[class_id]
                        clases_detectadas[class_name] = clases_detectadas.get(class_name, 0) + 1
                    
                    # Mostrar informaci√≥n
                    info = ", ".join([f"{k}: {v}" for k, v in clases_detectadas.items()])
                    cv2.putText(annotated_frame, info, (10, 30),
                               cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            else:
                annotated_frame = frame
            
            # Mostrar frame
            cv2.imshow('Detecci√≥n en Tiempo Real', annotated_frame)
            
            frame_count += 1
            
            # Salir con 'q'
            if cv2.waitKey(1) & 0xFF == ord('q'):
                break
        
        cap.release()
        cv2.destroyAllWindows()
        print("‚úÖ Sistema cerrado")

if __name__ == "__main__":
    MODEL_PATH = "../results/exp1_base/weights/best.pt"
    
    detector = DetectorSimple(MODEL_PATH)
    detector.ejecutar(camera_id=0)